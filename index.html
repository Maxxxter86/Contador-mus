<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <title>Marcador Mus (Puntos‚ÜíVacas‚ÜíTenis)</title>
  <meta name="description" content="Marcador de Mus por puntos, vacas y sets tipo tenis" />

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0b1220" />
  <meta name="background-color" content="#0b1220" />

  <!-- iOS (por si acaso) -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Marcador Mus" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <!-- Iconos -->
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png" />

  <style>
    :root{
      --bg:#0b1220; --card:#121b2f; --muted:#a7b0c0; --text:#eef2ff;
      --accent:#6ee7b7; --danger:#fb7185; --warn:#fbbf24;
      --border:rgba(255,255,255,.10); --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont,
                   "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell,
                   "Open Sans", "Helvetica Neue", sans-serif;
      background:
        radial-gradient(1200px 700px at 20% 0%, rgba(110,231,183,.12), transparent 55%),
        radial-gradient(900px 600px at 90% 20%, rgba(59,130,246,.12), transparent 55%),
        var(--bg);
      color:var(--text);
      padding:10px;
    }

    .wrap{max-width:1100px;margin:0 auto}
    header{display:flex;gap:12px;align-items:flex-start;justify-content:space-between;margin:8px 0 14px; flex-wrap:wrap}
    h1{font-size:20px;margin:0;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:13px;margin-top:4px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width: 940px){.grid{grid-template-columns: 1.3fr .7fr}}

    /* Mejoras m√≥vil */
    @media (max-width: 560px){
      body{padding:10px}
      h1{font-size:18px}
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Marcador Mus ‚Äî Puntos ‚Üí Vacas ‚Üí Tenis</h1>
      <div class="sub">Juego a 30 ¬∑ Vaca (mejor de 3 juegos) ¬∑ ‚ÄúJuego completo‚Äù = 2 vacas ¬∑ Tenis para juegos completos y sets</div>
    </div>
    <div class="meta">
      <span class="k">Set actual: <strong id="setIndex">1</strong></span>
      <span class="k">Modo tenis: <strong id="modeLabel">Normal</strong></span>
    </div>
  </header>

  <div class="grid">
    <!-- Marcador -->
    <section class="card">
      <div class="hd">
        <div class="pill">üß© Jerarqu√≠a: <span class="mono">30 ‚Üí Juego ‚Üí Vaca(2/3) ‚Üí 2 Vacas ‚Üí Tenis</span></div>
        <div class="pill mono" id="rulePill">Tenis: Set a 6 ¬∑ ventaja 2 ¬∑ TB en 6‚Äì6</div>
      </div>

      <div class="bd">
        <div class="teams">
          <!-- Equipo A -->
          <div class="team">
            <div class="teamName">
              <div class="name">Agus &amp; Marce</div>
              <div class="sets">Sets: <strong id="setsA">0</strong></div>
            </div>

            <div class="scoreGrid">
              <div class="big">
                <div class="label">Puntos (juego actual, a 30)</div>
                <div class="value" id="pointsA">0</div>
              </div>
              <div class="big">
                <div class="label">Vaca actual (juegos ganados, a 2)</div>
                <div class="value" id="gamesInVacaA">0</div>
              </div>

              <div class="big">
                <div class="label">Vacas en el ‚Äújuego completo‚Äù (a 2)</div>
                <div class="value" id="vacasA">0</div>
              </div>
              <div class="big">
                <div class="label">Tenis: juegos completos (set actual)</div>
                <div class="value" id="tennisGamesA">0</div>
              </div>
            </div>

            <div class="btnRow3">
              <button class="primary" onclick="addPoints('A', 1)">+1</button>
              <button class="primary" onclick="addPoints('A', 2)">+2</button>
              <button class="primary" onclick="addPoints('A', 3)">+3</button>
            </div>
            <div class="btnRow3">
              <button class="primary" onclick="addPoints('A', 4)">+4</button>
              <button class="warn" onclick="addPoints('A', 5)">+5</button>
              <button class="warn" onclick="addPoints('A', 10)">+10</button>
            </div>
            <div class="btnRow">
              <button class="ghost" onclick="addPoints('A', -1)">-1</button>
              <button class="ghost" onclick="awardGame('A')">üèÅ Forzar juego</button>
            </div>
          </div>

          <!-- Equipo B -->
          <div class="team">
            <div class="teamName">
              <div class="name">Miguel &amp; Tito</div>
              <div class="sets">Sets: <strong id="setsB">0</strong></div>
            </div>

            <div class="scoreGrid">
              <div class="big">
                <div class="label">Puntos (juego actual, a 30)</div>
                <div class="value" id="pointsB">0</div>
              </div>
              <div class="big">
                <div class="label">Vaca actual (juegos ganados, a 2)</div>
                <div class="value" id="gamesInVacaB">0</div>
              </div>

              <div class="big">
                <div class="label">Vacas en el ‚Äújuego completo‚Äù (a 2)</div>
                <div class="value" id="vacasB">0</div>
              </div>
              <div class="big">
                <div class="label">Tenis: juegos completos (set actual)</div>
                <div class="value" id="tennisGamesB">0</div>
              </div>
            </div>

            <div class="btnRow3">
              <button class="primary" onclick="addPoints('B', 1)">+1</button>
              <button class="primary" onclick="addPoints('B', 2)">+2</button>
              <button class="primary" onclick="addPoints('B', 3)">+3</button>
            </div>
            <div class="btnRow3">
              <button class="primary" onclick="addPoints('B', 4)">+4</button>
              <button class="warn" onclick="addPoints('B', 5)">+5</button>
              <button class="warn" onclick="addPoints('B', 10)">+10</button>
            </div>
            <div class="btnRow">
              <button class="ghost" onclick="addPoints('B', -1)">-1</button>
              <button class="ghost" onclick="awardGame('B')">üèÅ Forzar juego</button>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="controls">
          <button onclick="undo()">‚Ü©Ô∏è Deshacer</button>
          <button class="ghost" onclick="newMatch()">üÜï Nuevo partido</button>
          <button class="danger" onclick="resetAll()">üß® Reiniciar todo</button>
        </div>

        <div class="hint">
          Autom√°tico: al llegar a <strong>30 puntos</strong> se gana el <strong>juego</strong>.
          Con <strong>2 juegos</strong> se gana la <strong>vaca</strong>.
          Con <strong>2 vacas</strong> se gana un <strong>juego completo</strong> (eso suma en el tenis del set).
        </div>
      </div>
    </section>

    <!-- Ajustes + Historial -->
    <aside class="card">
      <div class="hd">
        <div class="pill">‚öôÔ∏è Tenis (para juegos completos)</div>
        <div class="pill">üìù Historial</div>
      </div>
      <div class="bd">
        <div class="row">
          <div>
            <label class="label" for="targetGames">Juegos completos para ganar set</label>
            <input class="smallInput" id="targetGames" type="number" min="1" value="6" />
          </div>
          <div>
            <label class="label" for="winBy">Ventaja m√≠nima</label>
            <input class="smallInput" id="winBy" type="number" min="1" value="2" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label class="label" for="useTiebreak">Tiebreak en empate</label>
            <select class="smallInput" id="useTiebreak">
              <option value="yes" selected>S√≠</option>
              <option value="no">No</option>
            </select>
          </div>
          <div>
            <label class="label" for="tbTarget">Objetivo TB (si hay)</label>
            <input class="smallInput" id="tbTarget" type="number" min="1" value="7" />
          </div>
        </div>

        <div style="margin-top:10px" class="controls">
          <button class="ghost" onclick="applySettings()">Aplicar tenis</button>
          <button class="ghost" onclick="exportJSON()">Exportar JSON</button>
        </div>

        <div class="hint">
          Nota: los ajustes aqu√≠ solo afectan a c√≥mo se cierran sets en el ‚Äútenis‚Äù de <em>juegos completos</em>.
        </div>

        <div style="margin-top:14px" class="history">
          <ul id="historyList"></ul>
        </div>
      </div>
    </aside>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  // =========================
  // Reglas fijas (mus)
  // =========================
  const POINTS_TO_WIN_GAME = 30;   // cada juego a 30 puntos
  const GAMES_TO_WIN_VACA = 2;     // vaca al mejor de 3 (gana 2 juegos)
  const VACAS_TO_WIN_TENNIS_GAME = 2; // ‚Äújuego completo‚Äù = 2 vacas

  // =========================
  // Estado + persistencia
  // =========================
  const STORAGE_KEY = "mus_puntos_vacas_tenis_v2";

  const defaultState = () => ({
    settings: { targetGames: 6, winBy: 2, useTiebreak: true, tbTarget: 7 }, // tenis para juegos completos
    // nivel mus
    mus: {
      pointsA: 0, pointsB: 0,                 // puntos del juego actual
      gamesInVacaA: 0, gamesInVacaB: 0,       // juegos ganados en la vaca actual
      vacasA: 0, vacasB: 0,                   // vacas ganadas dentro del ‚Äújuego completo‚Äù
    },
    // nivel tenis (juegos completos dentro del set actual)
    tennis: {
      gamesA: 0, gamesB: 0, inTiebreak: false // si us√°is TB para sets
    },
    sets: [], // cada set: {a,b,tiebreak:boolean}
    match: { setsA: 0, setsB: 0 },
    history: [],
    undoStack: []
  });

  let state = loadState();

  function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return defaultState();
      return deepMerge(defaultState(), JSON.parse(raw));
    }catch(e){ return defaultState(); }
  }
  function deepMerge(base, extra){
    for(const k in extra){
      if(extra[k] && typeof extra[k] === "object" && !Array.isArray(extra[k])){
        base[k] = deepMerge(base[k] || {}, extra[k]);
      } else base[k] = extra[k];
    }
    return base;
  }

  // =========================
  // UI helpers
  // =========================
  function snapshotForUndo(label){
    state.undoStack.push({ label, snapshot: JSON.parse(JSON.stringify(state)) });
    if(state.undoStack.length > 80) state.undoStack.shift();
  }
  function toast(msg){
    const el = document.getElementById("toast");
    el.textContent = msg;
    el.style.display = "block";
    clearTimeout(toast._t);
    toast._t = setTimeout(()=> el.style.display="none", 1600);
  }
  function addHistory(msg){
    const stamp = new Date().toLocaleString("es-ES",{hour:"2-digit",minute:"2-digit",day:"2-digit",month:"2-digit"});
    state.history.unshift({ msg, stamp });
    if(state.history.length > 120) state.history.pop();
  }
  function escapeHTML(s){
    return String(s).replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }

  // =========================
  // L√≥gica mus: puntos ‚Üí juego ‚Üí vaca ‚Üí juego completo
  // =========================
  function addPoints(team, delta){
    snapshotForUndo(`Puntos ${team} ${delta>0?'+':''}${delta}`);
    const key = team === "A" ? "pointsA" : "pointsB";
    state.mus[key] = Math.max(0, state.mus[key] + delta);

    addHistory(`${delta>=0?'+':'-'}${Math.abs(delta)} punto(s) a ${team==='A'?'Agus & Marce':'Miguel & Tito'} ¬∑ (${state.mus.pointsA}-${state.mus.pointsB})`);

    // Si llega a 30 o m√°s, gana juego autom√°ticamente
    if(state.mus[key] >= POINTS_TO_WIN_GAME){
      awardGame(team, true);
    } else {
      saveState(); render();
    }
  }

  // Award juego (gana un juego dentro de la vaca actual)
  function awardGame(team, fromAuto=false){
    snapshotForUndo(`Gana juego ${team}`);
    if(!fromAuto){
      addHistory(`üèÅ Juego forzado para ${team==='A'?'Agus & Marce':'Miguel & Tito'}`);
    } else {
      addHistory(`‚úÖ Juego (a ${POINTS_TO_WIN_GAME}) para ${team==='A'?'Agus & Marce':'Miguel & Tito'}`);
    }

    // reset puntos del juego actual
    state.mus.pointsA = 0;
    state.mus.pointsB = 0;

    // suma juego a la vaca
    if(team === "A") state.mus.gamesInVacaA++;
    else state.mus.gamesInVacaB++;

    // ¬øse cierra la vaca?
    if(state.mus.gamesInVacaA >= GAMES_TO_WIN_VACA || state.mus.gamesInVacaB >= GAMES_TO_WIN_VACA){
      const vacaWinner = state.mus.gamesInVacaA > state.mus.gamesInVacaB ? "A" : "B";
      closeVaca(vacaWinner);
    } else {
      saveState(); render();
    }
  }

  function closeVaca(winner){
    addHistory(`üêÆ Vaca para ${winner==='A'?'Agus & Marce':'Miguel & Tito'} ¬∑ (Juegos en vaca: ${state.mus.gamesInVacaA}-${state.mus.gamesInVacaB})`);
    toast(`Vaca: ${winner==='A'?'Agus & Marce':'Miguel & Tito'}`);

    // suma vaca al juego completo
    if(winner === "A") state.mus.vacasA++;
    else state.mus.vacasB++;

    // reset juegos de la vaca
    state.mus.gamesInVacaA = 0;
    state.mus.gamesInVacaB = 0;

    // ¬øse cierra el ‚Äújuego completo‚Äù (2 vacas)?
    if(state.mus.vacasA >= VACAS_TO_WIN_TENNIS_GAME || state.mus.vacasB >= VACAS_TO_WIN_TENNIS_GAME){
      const tennisGameWinner = state.mus.vacasA > state.mus.vacasB ? "A" : "B";
      closeTennisGame(tennisGameWinner);
    } else {
      saveState(); render();
    }
  }

  function closeTennisGame(winner){
    addHistory(`üéæ Juego completo (2 vacas) para ${winner==='A'?'Agus & Marce':'Miguel & Tito'}`);
    toast(`Juego completo: ${winner==='A'?'Agus & Marce':'Miguel & Tito'}`);

    // reset vacas del juego completo
    state.mus.vacasA = 0;
    state.mus.vacasB = 0;

    // suma en tenis (juegos completos del set actual)
    if(winner === "A") state.tennis.gamesA++;
    else state.tennis.gamesB++;

    evaluateSetEnd();
    saveState();
    render();
  }

  // =========================
  // L√≥gica tenis: juegos completos ‚Üí set
  // =========================
  function evaluateSetEnd(){
    const { targetGames, winBy, useTiebreak, tbTarget } = state.settings;
    let a = state.tennis.gamesA;
    let b = state.tennis.gamesB;

    // activar tiebreak al empate exacto
    if(useTiebreak && !state.tennis.inTiebreak && a === targetGames && b === targetGames){
      state.tennis.inTiebreak = true;
      addHistory(`‚ö° Tiebreak activado (${targetGames}-${targetGames}) ‚Äî ahora el set se decide a ${tbTarget} con ventaja ${winBy}`);
      toast("Tiebreak activado");
      return;
    }

    if(!state.tennis.inTiebreak){
      if((a >= targetGames || b >= targetGames) && Math.abs(a-b) >= winBy){
        closeSet(false);
      }
    } else {
      // en TB reutilizamos gamesA/gamesB como puntos de TB (simple)
      if((a >= tbTarget || b >= tbTarget) && Math.abs(a-b) >= winBy){
        closeSet(true);
      }
    }
  }

  function closeSet(wasTiebreak){
    const a = state.tennis.gamesA;
    const b = state.tennis.gamesB;

    state.sets.push({ a, b, tiebreak: wasTiebreak });
    if(a > b) state.match.setsA++;
    else state.match.setsB++;

    addHistory(`üèÜ Set para ${a>b?'Agus & Marce':'Miguel & Tito'} ¬∑ ${a}-${b}${wasTiebreak?' (TB)':''}`);
    toast(`Set ${state.sets.length}: ${a}-${b}${wasTiebreak?' (TB)':''}`);

    // reset set actual (tenis)
    state.tennis.gamesA = 0;
    state.tennis.gamesB = 0;
    state.tennis.inTiebreak = false;
  }

  // =========================
  // Controles generales
  // =========================
  function undo(){
    const last = state.undoStack.pop();
    if(!last){ toast("Nada que deshacer"); return; }
    state = last.snapshot;
    addHistory(`‚Ü©Ô∏è Deshacer: ${last.label}`);
    saveState(); render();
  }

  function newMatch(){
    snapshotForUndo("Nuevo partido");
    // Resetea todo el marcador pero conserva ajustes
    const keep = JSON.parse(JSON.stringify(state.settings));
    state = defaultState();
    state.settings = keep;
    addHistory("üÜï Nuevo partido (todo a 0; ajustes tenis se mantienen)");
    saveState(); render();
    toast("Nuevo partido");
  }

  function resetAll(){
    if(!confirm("Esto borrar√° TODO (marcador + historial + ajustes). ¬øSeguro?")) return;
    state = defaultState();
    saveState(); render();
    toast("Reiniciado");
  }

  // =========================
  // Ajustes tenis
  // =========================
  function applySettings(){
    const tg = parseInt(document.getElementById("targetGames").value, 10);
    const wb = parseInt(document.getElementById("winBy").value, 10);
    const ut = document.getElementById("useTiebreak").value === "yes";
    const tb = parseInt(document.getElementById("tbTarget").value, 10);

    if(!Number.isFinite(tg) || tg < 1) return toast("Juegos para set inv√°lido");
    if(!Number.isFinite(wb) || wb < 1) return toast("Ventaja inv√°lida");
    if(!Number.isFinite(tb) || tb < 1) return toast("Objetivo TB inv√°lido");

    snapshotForUndo("Aplicar ajustes tenis");
    state.settings.targetGames = tg;
    state.settings.winBy = wb;
    state.settings.useTiebreak = ut;
    state.settings.tbTarget = tb;
<script>
/* =========================================================
   REGLAS DE MUS
   ========================================================= */
const POINTS_TO_WIN_GAME = 30;          // Juego a 30 puntos
const GAMES_TO_WIN_VACA = 2;            // Vaca al mejor de 3 (gana 2)
const VACAS_TO_WIN_TENNIS_GAME = 2;     // Juego completo = 2 vacas

/* =========================================================
   ESTADO Y PERSISTENCIA
   ========================================================= */
const STORAGE_KEY = "mus_pwa_score_v1";

const defaultState = () => ({
  settings: {
    targetGames: 6,   // juegos completos para ganar set
    winBy: 2,
    useTiebreak: true,
    tbTarget: 7
  },
  mus: {
    pointsA: 0, pointsB: 0,
    gamesInVacaA: 0, gamesInVacaB: 0,
    vacasA: 0, vacasB: 0
  },
  tennis: {
    gamesA: 0, gamesB: 0,
    inTiebreak: false
  },
  sets: [],
  match: { setsA: 0, setsB: 0 },
  history: [],
  undoStack: []
});

let state = loadState();

function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function loadState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return defaultState();
    return Object.assign(defaultState(), JSON.parse(raw));
  } catch {
    return defaultState();
  }
}

/* =========================================================
   UTILIDADES
   ========================================================= */
function snapshot(label) {
  state.undoStack.push({
    label,
    snapshot: JSON.parse(JSON.stringify(state))
  });
  if (state.undoStack.length > 100) state.undoStack.shift();
}

function toast(msg) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(toast._t);
  toast._t = setTimeout(() => t.style.display = "none", 1500);
}

function log(msg) {
  const time = new Date().toLocaleTimeString("es-ES", { hour: "2-digit", minute: "2-digit" });
  state.history.unshift({ msg, time });
  if (state.history.length > 100) state.history.pop();
}

/* =========================================================
   L√ìGICA MUS
   ========================================================= */
function addPoints(team, value) {
  snapshot("Sumar puntos");
  const key = team === "A" ? "pointsA" : "pointsB";
  state.mus[key] = Math.max(0, state.mus[key] + value);

  log(`${team === "A" ? "Agus & Marce" : "Miguel & Tito"} +${value} puntos`);

  if (state.mus[key] >= POINTS_TO_WIN_GAME) {
    winGame(team);
  } else {
    saveState();
    render();
  }
}

function winGame(team) {
  snapshot("Ganar juego");
  log(`üèÅ Juego para ${team === "A" ? "Agus & Marce" : "Miguel & Tito"}`);

  state.mus.pointsA = 0;
  state.mus.pointsB = 0;

  if (team === "A") state.mus.gamesInVacaA++;
  else state.mus.gamesInVacaB++;

  if (
    state.mus.gamesInVacaA >= GAMES_TO_WIN_VACA ||
    state.mus.gamesInVacaB >= GAMES_TO_WIN_VACA
  ) {
    winVaca(state.mus.gamesInVacaA > state.mus.gamesInVacaB ? "A" : "B");
  } else {
    saveState();
    render();
  }
}

function winVaca(team) {
  log(`üêÆ Vaca para ${team === "A" ? "Agus & Marce" : "Miguel & Tito"}`);
  toast("¬°Vaca!");

  state.mus.gamesInVacaA = 0;
  state.mus.gamesInVacaB = 0;

  if (team === "A") state.mus.vacasA++;
  else state.mus.vacasB++;

  if (
    state.mus.vacasA >= VACAS_TO_WIN_TENNIS_GAME ||
    state.mus.vacasB >= VACAS_TO_WIN_TENNIS_GAME
  ) {
    winTennisGame(state.mus.vacasA > state.mus.vacasB ? "A" : "B");
  } else {
    saveState();
    render();
  }
}

function winTennisGame(team) {
  log(`üéæ Juego completo para ${team === "A" ? "Agus & Marce" : "Miguel & Tito"}`);
  toast("Juego completo");

  state.mus.vacasA = 0;
  state.mus.vacasB = 0;

  if (team === "A") state.tennis.gamesA++;
  else state.tennis.gamesB++;

  checkSetEnd();
  saveState();
  render();
}

/* =========================================================
   TENIS (SETS)
   ========================================================= */
function checkSetEnd() {
  const { targetGames, winBy, useTiebreak, tbTarget } = state.settings;
  const a = state.tennis.gamesA;
  const b = state.tennis.gamesB;

  if (useTiebreak && !state.tennis.inTiebreak && a === targetGames && b === targetGames) {
    state.tennis.inTiebreak = true;
    log("‚ö° Tiebreak activado");
    toast("Tiebreak");
    return;
  }

  if (!state.tennis.inTiebreak) {
    if ((a >= targetGames || b >= targetGames) && Math.abs(a - b) >= winBy) {
      closeSet(false);
    }
  } else {
    if ((a >= tbTarget || b >= tbTarget) && Math.abs(a - b) >= winBy) {
      closeSet(true);
    }
  }
}

function closeSet(tb) {
  const a = state.tennis.gamesA;
  const b = state.tennis.gamesB;

  state.sets.push({ a, b, tb });
  if (a > b) state.match.setsA++;
  else state.match.setsB++;

  log(`üèÜ Set ${a}-${b}${tb ? " (TB)" : ""}`);
  toast("Set ganado");

  state.tennis.gamesA = 0;
  state.tennis.gamesB = 0;
  state.tennis.inTiebreak = false;
}

/* =========================================================
   CONTROLES
   ========================================================= */
function undo() {
  const last = state.undoStack.pop();
  if (!last) return toast("Nada que deshacer");
  state = last.snapshot;
  log(`‚Ü©Ô∏è Deshacer: ${last.label}`);
  saveState();
  render();
}

function newMatch() {
  snapshot("Nuevo partido");
  const keepSettings = state.settings;
  state = defaultState();
  state.settings = keepSettings;
  log("üÜï Nuevo partido");
  saveState();
  render();
}

function resetAll() {
  if (!confirm("¬øBorrar todo el marcador?")) return;
  state = defaultState();
  saveState();
  render();
}

/* =========================================================
   RENDER
   ========================================================= */
function render() {
  // Mus
  pointsA.textContent = state.mus.pointsA;
  pointsB.textContent = state.mus.pointsB;
  gamesInVacaA.textContent = state.mus.gamesInVacaA;
  gamesInVacaB.textContent = state.mus.gamesInVacaB;
  vacasA.textContent = state.mus.vacasA;
  vacasB.textContent = state.mus.vacasB;

  // Tenis
  tennisGamesA.textContent = state.tennis.gamesA;
  tennisGamesB.textContent = state.tennis.gamesB;
  setsA.textContent = state.match.setsA;
  setsB.textContent = state.match.setsB;
  setIndex.textContent = state.sets.length + 1;
  modeLabel.textContent = state.tennis.inTiebreak ? "Tiebreak" : "Normal";

  // Historial
  historyList.innerHTML = "";
  state.history.forEach(h => {
    const li = document.createElement("li");
    li.innerHTML = `<strong>${h.msg}</strong><span class="mono">${h.time}</span>`;
    historyList.appendChild(li);
  });

  saveState();
}

   // Helper
  const $ = (id) => document.getElementById(id);

  function render() {
    // Mus
    $("pointsA").textContent = state.mus.pointsA;
    $("pointsB").textContent = state.mus.pointsB;
    $("gamesInVacaA").textContent = state.mus.gamesInVacaA;
    $("gamesInVacaB").textContent = state.mus.gamesInVacaB;
    $("vacasA").textContent = state.mus.vacasA;
    $("vacasB").textContent = state.mus.vacasB;

    // Tenis
    $("tennisGamesA").textContent = state.tennis.gamesA;
    $("tennisGamesB").textContent = state.tennis.gamesB;
    $("setsA").textContent = state.match.setsA;
    $("setsB").textContent = state.match.setsB;

    $("setIndex").textContent = (state.sets.length + 1);
    $("modeLabel").textContent = state.tennis.inTiebreak ? "Tiebreak" : "Normal";

    // Historial
    const ul = $("historyList");
    ul.innerHTML = "";
    state.history.forEach((h) => {
      const li = document.createElement("li");
      li.innerHTML = `<span><strong>${escapeHTML(h.msg)}</strong></span><span class="mono">${escapeHTML(h.stamp || h.time || "")}</span>`;
      ul.appendChild(li);
    });

    saveState();
  }

  // Muy importante: arranca cuando el DOM est√© listo
  document.addEventListener("DOMContentLoaded", () => {
    render();
  });

  // Service Worker (PWA)
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./service-worker.js");
    });
  }
    
/* =========================================================
   SERVICE WORKER (PWA)
   ========================================================= */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./service-worker.js");
  });
}

/* INIT */
render();
</script>
</body>
</html>
